generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  secondmeUserId    String   @unique @map("secondme_user_id")
  accessToken       String   @map("access_token")
  refreshToken      String   @map("refresh_token")
  tokenExpiresAt    DateTime @map("token_expires_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  sessions          Session[]
  questionSubscriptions QuestionSubscription[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("sessions")
}

model Question {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id")  // 可空，不需要外键关联
  content     String
  imageUrl    String?  @map("image_url")
  arenaType   String   @default("toxic") @map("arena_type")
  status      String   @default("pending") // RECRUITING, DEBATING_R1, DEBATING_R2, CLOSED
  round       Int      @default(0)
  nextTurnAt  DateTime? @map("next_turn_at")
  createdAt   DateTime @default(now()) @map("created_at")
  deletedAt   DateTime? @map("deleted_at")

  votes       Vote[]
  voteTasks   VoteTask[]
  debateRoles DebateRole[]
  debateTurns DebateTurn[]
  subscriptions QuestionSubscription[]

  @@map("questions")
}

model QuestionSubscription {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  questionId String   @map("question_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@index([questionId])
  @@map("question_subscriptions")
}

model DebateRole {
  id            String   @id @default(cuid())
  questionId    String   @map("question_id")
  participantId String   @map("participant_id")
  role          String   // PRO_1, PRO_2, CON_1, CON_2, AUDIENCE, HOST
  initialStance Int      // -100 to 100
  currentStance Int      // -100 to 100
  isDevilsAdvocate Boolean @default(false) @map("is_devils_advocate")
  
  question      Question    @relation(fields: [questionId], references: [id])
  participant   Participant @relation(fields: [participantId], references: [id])

  @@unique([questionId, participantId])
  @@map("debate_roles")
}

model DebateTurn {
  id          String   @id @default(cuid())
  questionId  String   @map("question_id")
  speakerId   String   @map("speaker_id")
  round       Int
  content     String   @db.Text
  type        String   // ARGUMENT, REBUTTAL, SUMMARY
  voteSwing   Float?   // Impact score
  createdAt   DateTime @default(now()) @map("created_at")

  question    Question    @relation(fields: [questionId], references: [id])
  speaker     Participant @relation(fields: [speakerId], references: [id])

  @@map("debate_turns")
}

model Vote {
  id            String   @id @default(cuid())
  questionId    String?  @map("question_id")  // 可空
  question      Question? @relation(fields: [questionId], references: [id])
  participantId String?  @map("participant_id")
  position      Int
  comment       String
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([questionId, participantId])
  @@map("votes")
}

model Participant {
  id            String   @id @default(cuid())
  secondmeId    String   @unique @map("secondme_id")
  name          String
  avatarUrl     String?  @map("avatar_url")
  interests     String[]  @default([])
  isActive      Boolean  @default(true) @map("is_active")
  responseCount Int      @default(0) @map("response_count")
  lastActiveAt  DateTime? @map("last_active_at")
  createdAt     DateTime @default(now()) @map("created_at")

  debateRoles   DebateRole[]
  debateTurns   DebateTurn[]
  voteTasks     VoteTask[]

  @@map("participants")
}

model VoteTask {
  id            String      @id @default(cuid())
  questionId    String      @map("question_id")
  participantId String      @map("participant_id")
  status        String      @default("pending") // pending, running, done, failed
  attempts      Int         @default(0)
  lastError     String?     @map("last_error")
  nextRetryAt   DateTime?   @map("next_retry_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  question      Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([questionId, participantId])
  @@index([status, nextRetryAt])
  @@map("vote_tasks")
}
